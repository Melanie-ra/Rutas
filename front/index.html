<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNI - Motor de Rutas</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <link rel="stylesheet" href="styles/main.css?v=1.3">
</head>
<body x-data="motorRutas()">
    
    <div style="position: fixed; left: 0; right: 0; top: 0; z-index: 1037; height: 3rem; background: #99020B; display: flex; align-items: center; padding: 0 1rem; justify-content: flex-start;">
        <div style="display: flex; align-items: center;">
            <img src="img/uni_blanco.ico" style="width: 2.3rem; margin-left: 1rem;" alt="logouni">
            <img src="img/slasch.ico" style="width: 2.3rem; margin-left: 0rem;" alt="slasch">
            <div style="margin-left: 0rem; vertical-align: middle;">
                <span style="color: white; font-size: 12px; font-weight: bold;">UNI - Motor de Rutas</span>
            </div>
        </div>
        <div class="ml-auto flex items-center" style="margin-left: auto; display: flex; align-items: center;">
            <i class="fas fa-user-circle" style="margin-right: 12px; font-size: 24px; color: white;"></i>
            <div style="margin-right: 2rem; vertical-align: middle;">
                <span style="color: white; font-size: 12px; font-weight: bold;" x-text="`Usuario: ${loggedUser.fullName}`"></span>
            </div>
            <div class="tooltip">
                <button @click="logout()" style="padding: 0.5rem; background: #99020B; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </div>

    
    <main class="main-motor-content">
        <h2 class="subtitulos">Motor de Rutas</h2>
        
        <div class="motor-container">
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                <div style="flex: 1;">
                    <label style="margin-right: 1.5rem;">Clasificador de tr√°mites</label>
                    <select x-model="selectedClasificador" @change="onClasificadorChange()" 
                            @click="loadRoutesOnClick()"
                            class="input-vigencia"
                            style="width: 62.5%; border: 0.5px solid #9a9a9a6c; height: 2rem; padding: 0.2rem;">
                        <option value="">Seleccione un clasificador</option>
                        <template x-for="ruta in availableRoutes" :key="ruta.value">
                            <option :value="ruta.value" x-text="ruta.label"></option>
                        </template>
                        <option x-show="apiError && availableRoutes.length === 0" disabled value="">Seleccione..</option>
                    </select>
                </div>
            </div>

           
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <label style="margin-right: 2.6rem;">Descripci√≥n</label>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <textarea class="input-vigencia" 
                          style="width: 73%; padding: 0.5rem; height: 2.3rem; border: 0.5px solid #9a9a9a6c;"></textarea>
                
                <div style="display: flex; flex-direction: column; gap: 0.8rem; width: 190px; margin-left: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <label>Vigencia</label>
                        <input type="text" class="input-vigencia" 
                               style="width: 50px; padding: 0.5rem; border: 0.5px solid #9a9a9a6c; height: 1.8rem; margin-left: 1.5rem;">
                        <input type="text" class="input-vigencia" 
                               style="width: 50px; padding: 0.5rem; border: 0.5px solid #9a9a9a6c; height: 1.8rem;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <label>Plazo (D√≠as)</label>
                        <input type="text" class="input-vigencia" 
                               style="width: 110px; padding: 0.5rem; border: 0.5px solid #9a9a9a6c; height: 1.8rem;">
                    </div>
                </div>
                
                <button type="submit" 
                        style="background: #99020B; color: white; padding: 0.2rem 0.8rem; border-radius: 6px; align-self: flex-start; display: flex; align-items: center; gap: 0.3rem; border: none; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i>
                    Enviar
                </button>
            </div>

           
            <div style="margin-top: 2rem;">
                <label style="margin-right: 1rem;">Obligatoria</label>
                <input type="checkbox" x-model="isObligatoria" class="checkbox-red" 
                       style="margin-right: 1rem; vertical-align: middle;">

                
                <div style="display: flex; align-items: center; margin-top: 1rem; gap: 1rem;">
                    
                    <div style="flex: 0 0 200px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1rem; margin: 0;">Disponibles</h3>
                            <div class="tooltip">
                                <button @click="reloadApiData()" 
                                        :disabled="isLoadingApi || !selectedClasificador"
                                        :class="(isLoadingApi || !selectedClasificador) ? 'btn-disabled' : ''"
                                        style="background: #99020B; color: white; padding: 0.4rem; border-radius: 3px; border: none; cursor: pointer; font-size: 0.7rem;">
                                    <i :class="isLoadingApi ? 'fas fa-spinner fa-spin' : 'fas fa-sync'"></i>
                                </button>
                                <span class="tooltiptext" x-text="!selectedClasificador ? 'Selecciona un clasificador primero' : (isLoadingApi ? 'Cargando...' : 'Recargar datos de la API UNI')"></span>
                            </div>
                        </div>
                        
                        <div style="border: 1px solid #ccc; padding: 0.5rem; height: 400px; overflow-y: auto; background-color: #fff;">
                            
                            <div x-show="isLoadingApi" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666; text-align: center;">
                                <div class="spinner" style="margin-bottom: 1rem;"></div>
                                <span style="font-size: 0.9rem;">Conectando a la API UNI...</span>
                                <span style="font-size: 0.8rem; margin-top: 0.5rem; color: #999;">Cargando datos reales del servidor</span>
                            </div>

                           
                            <div x-show="!isLoadingApi && apiError" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #dc3545; text-align: center; padding: 1rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                                <div style="font-size: 0.8rem; margin-bottom: 0.5rem;" x-text="apiError"></div>
                                <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                    <button @click="reloadApiData()" 
                                            style="background: #99020B; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; border: none; cursor: pointer; font-size: 0.7rem;">
                                        Reintentar
                                    </button>
                                </div>
                            </div>

                            
                            <div x-show="!isLoadingApi && !apiError && !selectedClasificador" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6c757d; text-align: center; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                                <div style="font-size: 0.9rem; line-height: 1.4;">
                                    Haz clic en el dropdown para cargar las rutas disponibles, luego selecciona una ruta para ver los campos
                                </div>
                            </div>

                            
                            <template x-show="!isLoadingApi && !apiError && selectedClasificador && establecimientoListState.length > 0" x-for="(item, index) in establecimientoListState" :key="index">
                                <div @click="handleItemClick(index, false)" 
                                     :class="selectedItemsIndices.includes(index) ? 'list-item selected' : 'list-item'"
                                     x-text="item"></div>
                            </template>
                        </div>
                    </div>

                   
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;">
                        <div class="tooltip">
                            <button @click="moveAllToRight()" 
                                    :disabled="!selectedClasificador || establecimientoListState.length === 0"
                                    :class="(!selectedClasificador || establecimientoListState.length === 0) ? 'btn-disabled' : ''"
                                    style="background: #99020B; color: white; border: none; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-radius: 4px;">
                                <i class="fas fa-fast-forward"></i>
                            </button>
                        </div>

                        <div class="tooltip">
                            <button @click="moveToRight()" 
                                    :disabled="!selectedClasificador || selectedItemsIndices.length === 0"
                                    :class="(!selectedClasificador || selectedItemsIndices.length === 0) ? 'btn-disabled' : ''"
                                    style="background: #ccc; color: #333; border: none; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-radius: 4px;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="tooltip">
                            <button @click="moveToLeft()" 
                                    :disabled="!selectedClasificador || selectedItemsIndices.length === 0"
                                    :class="(!selectedClasificador || selectedItemsIndices.length === 0) ? 'btn-disabled' : ''"
                                    style="background: #ccc; color: #333; border: none; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-radius: 4px;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>

                        <div class="tooltip">
                            <button @click="moveAllToLeft()" 
                                    :disabled="!selectedClasificador || selectedItems.length === 0"
                                    :class="(!selectedClasificador || selectedItems.length === 0) ? 'btn-disabled' : ''"
                                    style="background: #99020B; color: white; border: none; padding: 0.5rem; cursor: pointer; border-radius: 4px;">
                                <i class="fas fa-fast-backward"></i>
                            </button>
                        </div>
                    </div>

                    
                    <div style="flex: 0 0 200px;">
                        <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Seleccionados</h3>
                        <div style="border: 1px solid #ccc; padding: 0.5rem; height: 400px; overflow-y: auto; background-color: #fff;">
                            <template x-for="(item, index) in selectedItems" :key="index">
                                <div @click="handleItemClick(index, true)" 
                                     :class="selectedItemsIndices.includes(index + establecimientoListState.length) ? 'list-item selected' : 'list-item'"
                                     x-text="item"></div>
                            </template>
                        </div>
                    </div>

                    
                    <div style="flex: 1; min-width: 600px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="font-size: 1rem; margin: 0;">Diagrama de Flujo</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button @click="centerGraph()" 
                                        style="background: #99020B; color: white; padding: 0.4rem; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                    <i class="fas fa-crosshairs"></i>
                                    Centrar
                                </button>
                                <button @click="clearConnections()" 
                                        style="background: #99020B; color: white; padding: 0.4rem; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.3rem;">
                                    <i class="fas fa-trash"></i>
                                    Limpiar
                                </button>
                            </div>
                        </div>
                        <div id="cy" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 0.5rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function motorRutas() {
            return {
                
                isAuthenticated: true,
                loggedUser: { fullName: 'Usuario Demo' },
                isMenuOpen: false,
                selectedOption: 'Motor de rutas',
                iframeSrc: '',
                isObligatoria: false,
                selectedItemsIndices: [],
                selectedItems: [],
                edges: [],
                isLoadingApi: false,
                apiError: null,
                nombreRuta: '',
                selectedClasificador: '',
                establecimientoListState: [],
                cyRef: null,
                availableRoutes: [],
                routeInfo: null,
                apiNodes: [],
                apiEdges: [],

                
                menuOptions: [
                    {
                        label: 'Motor de rutas',
                        value: 'search',
                        href: '/',
                        iconClass: 'fas fa-route'
                    }
                ],

                
                init() {
                    console.log('Inicializando Alpine.js component...');
                    
                    this.availableRoutes = [];
                    this.isLoadingApi = false;
                    this.$nextTick(() => {
                        this.initCytoscape();
                    });
                },

              
                toggleMenu() {
                    this.isMenuOpen = !this.isMenuOpen;
                },

                handleMenuClick(option) {
                    this.selectedOption = option.label;
                    this.iframeSrc = option.href;
                },

                logout() {
                    this.isAuthenticated = false;
                    this.loggedUser = null;
                    document.cookie = 'loginUser=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                },

                
                handleItemClick(index, isRightList) {
                    const baseIndex = isRightList ? this.establecimientoListState.length : 0;
                    const adjustedIndex = index + baseIndex;
                    
                    if (this.selectedItemsIndices.includes(adjustedIndex)) {
                        this.selectedItemsIndices = this.selectedItemsIndices.filter(i => i !== adjustedIndex);
                    } else {
                        this.selectedItemsIndices.push(adjustedIndex);
                    }
                },

                moveToRight() {
                    if (this.selectedItemsIndices.length > 0) {
                        const sortedIndices = [...this.selectedItemsIndices].sort((a, b) => b - a);
                        let newEstablecimientoList = [...this.establecimientoListState];
                        const movedItems = sortedIndices
                            .filter(index => index < this.establecimientoListState.length)
                            .map(index => newEstablecimientoList[index]);

                        sortedIndices.forEach(index => {
                            if (index < newEstablecimientoList.length) {
                                newEstablecimientoList.splice(index, 1);
                            }
                        });

                        this.establecimientoListState = newEstablecimientoList;
                        this.selectedItems = [...this.selectedItems, ...movedItems];
                        this.selectedItemsIndices = [];

                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    }
                },

                moveToLeft() {
                    if (this.selectedItemsIndices.length > 0) {
                        const sortedIndices = [...this.selectedItemsIndices].sort((a, b) => b - a);
                        let newSelectedItems = [...this.selectedItems];
                        const movedItems = [];

                        const selectedListIndices = sortedIndices.filter(index => index >= this.establecimientoListState.length);
                        
                        selectedListIndices.forEach(index => {
                            const realIndex = index - this.establecimientoListState.length;
                            if (realIndex >= 0 && realIndex < newSelectedItems.length) {
                                movedItems.push(newSelectedItems[realIndex]);
                                newSelectedItems.splice(realIndex, 1);
                            }
                        });

                        this.establecimientoListState = [...this.establecimientoListState, ...movedItems];
                        this.selectedItems = newSelectedItems;
                        this.selectedItemsIndices = [];

                        this.edges = this.edges.filter(edge => 
                            !movedItems.includes(edge.source) && !movedItems.includes(edge.target)
                        );

                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    }
                },

                moveAllToRight() {
                    if (this.establecimientoListState.length > 0) {
                        console.log('üì§ Moviendo todos los elementos disponibles a seleccionados');
                        this.selectedItems = [...this.selectedItems, ...this.establecimientoListState];
                        this.establecimientoListState = [];
                        this.selectedItemsIndices = [];

                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    }
                },

                moveAllToLeft() {
                    if (this.selectedItems.length > 0) {
                        console.log('üì• Moviendo todos los elementos seleccionados a disponibles');
                        this.establecimientoListState = [...this.establecimientoListState, ...this.selectedItems];
                        this.selectedItems = [];
                        this.selectedItemsIndices = [];
                        this.edges = [];

                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    }
                },

                // Clasificador change handler
                onClasificadorChange() {
                    console.log('üìã Clasificador seleccionado:', this.selectedClasificador);
                    
                    if (!this.selectedClasificador) {
                        this.establecimientoListState = [];
                        this.selectedItems = [];
                        this.edges = [];
                        this.selectedItemsIndices = [];
                        this.apiError = null;
                        this.isLoadingApi = false;
                        this.nombreRuta = '';
                        console.log('üßπ Limpiando selecci√≥n porque no hay clasificador seleccionado');
                        
                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    } else {
                        
                        console.log('üîÑ Cargando datos espec√≠ficos de la ruta seleccionada...');
                        this.fetchSpecificRouteData();
                    }
                },

                
                async loadRoutesOnClick() {
                    
                    if (this.availableRoutes.length === 0 && !this.isLoadingApi) {
                        console.log('üîÑ Cargando rutas disponibles al hacer clic...');
                        await this.loadAvailableRoutesFromApi();
                    }
                },

                async loadAvailableRoutesFromApi() {
                    console.log('üîÑ Cargando lista de rutas desde la API...');
                    this.isLoadingApi = true;
                    this.apiError = null;
                    this.establecimientoListState = [];

                    const urls = [
                        'https://cors-anywhere.herokuapp.com/https://sgduni.uni.edu.pe/rutas-server/api/free/rutas',
                        'https://api.allorigins.win/raw?url=https://sgduni.uni.edu.pe/rutas-server/api/free/rutas',
                        'https://sgduni.uni.edu.pe/rutas-server/api/free/rutas'
                    ];

                    const fetchWithTimeout = async (url, timeout = 15000) => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);
                        
                        try {
                            console.log(`üåê Intentando conectar a: ${url}`);
                            
                            const fetchOptions = {
                                method: 'GET',
                                signal: controller.signal
                            };
                            
                            if (!url.includes('cors-anywhere') && !url.includes('allorigins')) {
                                fetchOptions.headers = {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                };
                                fetchOptions.mode = 'cors';
                            }
                            
                            const response = await fetch(url, fetchOptions);
                            clearTimeout(timeoutId);
                            console.log(`üì° Respuesta recibida - Status: ${response.status}`);
                            return response;
                        } catch (error) {
                            clearTimeout(timeoutId);
                            console.error(`‚ùå Error en fetch: ${error.name} - ${error.message}`);
                            throw error;
                        }
                    };

                    for (const url of urls) {
                        try {
                            const response = await fetchWithTimeout(url, 15000);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('üìä Lista de rutas recibida de la API:', data);
                            
                            if (Array.isArray(data) && data.length > 0) {
                               
                                this.availableRoutes = data.map(ruta => ({
                                    value: `api_route_${ruta.idRuta || ruta.id}`,
                                    label: ruta.nombreRuta || ruta.name || 'Ruta sin nombre',
                                    routeData: ruta 
                                }));
                                
                                console.log(`‚úÖ Se cargaron ${data.length} rutas de la API`);
                                this.isLoadingApi = false;
                                this.apiError = null;
                                return;
                            } else {
                                throw new Error('La respuesta no contiene un array v√°lido de rutas');
                            }
                        } catch (error) {
                            console.error(`‚ùå Error con URL ${url}:`, error);
                            if (error.name === 'AbortError') {
                                console.log('‚è∞ Timeout - la API tard√≥ m√°s de 15 segundos');
                            }
                            continue;
                        }
                    }

                   
                    console.log('‚ö†Ô∏è Endpoint general no disponible, cargando ruta de ejemplo...');
                    this.isLoadingApi = false;
                    this.apiError = null;
                    
                   
                    this.availableRoutes = [{
                        value: 'api_route_1',
                        label: 'SOLICITA EXAMEN DE REGULARIZACI√ìN',
                        routeData: { idRuta: 1, nombreRuta: 'SOLICITA EXAMEN DE REGULARIZACI√ìN' }
                    }];
                    
                    console.log('‚úÖ Ruta de ejemplo cargada desde API individual');
                },

                
                async fetchSpecificRouteData() {
                    if (!this.selectedClasificador) return;

                    const routeId = this.selectedClasificador.replace('api_route_', '');
                    
                    console.log(`üîÑ Cargando datos espec√≠ficos de la ruta ID: ${routeId}`);
                    this.isLoadingApi = true;
                    this.apiError = null;
                    this.nombreRuta = '';

                    const urls = [
                        `https://cors-anywhere.herokuapp.com/https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/${routeId}`,
                        `https://api.allorigins.win/raw?url=https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/${routeId}`,
                        `https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/${routeId}`
                    ];

                    const fetchWithTimeout = async (url, timeout = 15000) => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);
                        
                        try {
                            console.log(`üåê Intentando conectar a: ${url}`);
                            
                            const fetchOptions = {
                                method: 'GET',
                                signal: controller.signal
                            };
                            
                            if (!url.includes('cors-anywhere') && !url.includes('allorigins')) {
                                fetchOptions.headers = {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                };
                                fetchOptions.mode = 'cors';
                            }
                            
                            const response = await fetch(url, fetchOptions);
                            clearTimeout(timeoutId);
                            console.log(`üì° Respuesta recibida - Status: ${response.status}`);
                            return response;
                        } catch (error) {
                            clearTimeout(timeoutId);
                            console.error(`‚ùå Error en fetch: ${error.name} - ${error.message}`);
                            throw error;
                        }
                    };

                    for (const url of urls) {
                        try {
                            const response = await fetchWithTimeout(url, 15000);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('üìä Datos espec√≠ficos de la ruta recibidos:', data);
                            
                            if (!data.graph || !data.graph.elements || !data.graph.elements.nodes) {
                                throw new Error('Estructura inv√°lida: falta graph, elements o nodes');
                            }
                            
                            this.processApiData(data);
                            return;
                            
                        } catch (error) {
                            console.error(`‚ùå Error con URL ${url}:`, error);
                            if (error.name === 'AbortError') {
                                console.log('‚è∞ Timeout - la API tard√≥ m√°s de 15 segundos');
                            }
                            continue;
                        }
                    }
                    
                    this.isLoadingApi = false;
                    this.apiError = 'No se pudo cargar los datos espec√≠ficos de la ruta. Verifique su conexi√≥n a internet.';
                },

                async fetchApiData() {
                    console.log('Iniciando fetch de datos de la API...');
                    this.isLoadingApi = true;
                    this.apiError = null;
                    this.nombreRuta = '';

                    const urls = [
                        'https://cors-anywhere.herokuapp.com/https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/1',
                        'https://api.allorigins.win/raw?url=https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/1',
                        'https://sgduni.uni.edu.pe/rutas-server/api/free/rutas/1'
                    ];
                    
                    const fetchWithTimeout = async (url, timeout = 15000) => {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeout);
                        
                        try {
                            console.log(`üåê Intentando conectar a: ${url}`);
                            
                            const fetchOptions = {
                                method: 'GET',
                                signal: controller.signal
                            };
                            
                            if (!url.includes('cors-anywhere') && !url.includes('allorigins')) {
                                fetchOptions.headers = {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                };
                                fetchOptions.mode = 'cors';
                            }
                            
                            const response = await fetch(url, fetchOptions);
                            clearTimeout(timeoutId);
                            console.log(`üì° Respuesta recibida - Status: ${response.status}`);
                            return response;
                        } catch (error) {
                            clearTimeout(timeoutId);
                            console.error(`‚ùå Error en fetch: ${error.name} - ${error.message}`);
                            throw error;
                        }
                    };
                    
                    for (const url of urls) {
                        try {
                            const response = await fetchWithTimeout(url, 15000);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            console.log('üìä Datos completos recibidos de la API:', data);
                            
                            if (!data.graph || !data.graph.elements || !data.graph.elements.nodes) {
                                throw new Error('Estructura inv√°lida: falta graph, elements o nodes');
                            }
                            
                            this.processApiData(data);
                            return;
                            
                        } catch (error) {
                            console.error(`‚ùå Error con URL ${url}:`, error);
                            if (error.name === 'AbortError') {
                                console.log('‚è∞ Timeout - la API tard√≥ m√°s de 15 segundos');
                            }
                            continue;
                        }
                    }
                    
                    this.isLoadingApi = false;
                    this.apiError = 'No se pudo conectar a la API. Verifique su conexi√≥n a internet o intente m√°s tarde.';
                },

                processApiData(data) {
                    console.log('üìä Procesando datos completos de la API...');
                    
                    console.log('Datos recibidos:', data);
                    
                    this.nombreRuta = data.nombreRuta || data.graph?.nombreRuta || 'Nombre no disponible';
                    console.log('Nombre de ruta asignado:', this.nombreRuta);

                    this.routeInfo = {
                        idRuta: data.idRuta,
                        codigoRuta: data.codigoRuta,
                        nombreRuta: this.nombreRuta,
                        idDependenciaEntrada: data.idDependenciaEntrada,
                        idDependenciaReferencia: data.idDependenciaReferencia,
                        idVersion: data.idVersion,
                        numeroVersion: data.numeroVersion
                    };

                    const nodes = data.graph.elements.nodes.map(node => ({
                        id: node.id,
                        name: node.name
                    }));
                    
                    const apiEdges = data.graph.elements.edges.map(edge => ({
                        source: edge.source,
                        target: edge.target,
                        tiempo: edge.tiempo || 0,
                        accion: edge.accion || '',
                        accion_texto: edge.accion_texto || ''
                    }));

                    console.log('‚úÖ API funcion√≥ correctamente:');
                    console.log('- Ruta:', this.nombreRuta);
                    console.log('- Nodos:', nodes.length);
                    console.log('- Aristas:', apiEdges.length);
                    
                    this.establecimientoListState = nodes.map(node => node.name);
                    this.apiNodes = nodes;
                    this.apiEdges = apiEdges;
                    
                    if (data.nombreRuta) {
                        const existingRoute = this.availableRoutes.find(route => route.label === data.nombreRuta);
                        if (!existingRoute) {
                            this.availableRoutes.push({
                                value: `api_route_${data.idRuta || 'current'}`,
                                label: data.nombreRuta
                            });
                        }
                    }
                    
                    this.isLoadingApi = false;
                    this.apiError = null;
                },

                async reloadApiData() {
                    console.log('üîÑ Recargando datos...');
                    
                    if (!this.selectedClasificador) {
                        this.apiError = 'Selecciona un clasificador primero';
                        return false;
                    }
                    
                    return this.fetchSpecificRouteData();
                },

                loadApiConnections() {
                    if (!this.apiEdges || this.apiEdges.length === 0) {
                        console.log('‚ö†Ô∏è No hay aristas predefinidas en la API');
                        return;
                    }

                    console.log('üîó Cargando conexiones predefinidas de la API...');
                    
                    const idToNameMap = {};
                    this.apiNodes.forEach(node => {
                        idToNameMap[node.id] = node.name;
                    });

                    const convertedEdges = [];
                    this.apiEdges.forEach(apiEdge => {
                        const sourceName = idToNameMap[apiEdge.source];
                        const targetName = idToNameMap[apiEdge.target];
                        
                        if (sourceName && targetName && 
                            (this.selectedItems.includes(sourceName) || sourceName === 'INICIO') &&
                            (this.selectedItems.includes(targetName) || targetName === 'FIN')) {
                            
                            convertedEdges.push({
                                source: sourceName,
                                target: targetName,
                                tiempo: apiEdge.tiempo,
                                accion: apiEdge.accion,
                                accion_texto: apiEdge.accion_texto
                            });
                        }
                    });

                    if (convertedEdges.length > 0) {
                        this.edges = convertedEdges;
                        console.log(`‚úÖ Se cargaron ${convertedEdges.length} conexiones predefinidas`);
                        
                        this.$nextTick(() => {
                            this.updateCytoscapeGraph();
                        });
                    } else {
                        console.log('‚ÑπÔ∏è No hay conexiones v√°lidas para los nodos seleccionados');
                    }
                },

                getEdgeInfo(sourceId, targetId) {
                    if (!this.apiEdges) return null;
                    
                    const apiEdge = this.apiEdges.find(edge => 
                        edge.source === sourceId && edge.target === targetId
                    );
                    
                    return apiEdge ? {
                        tiempo: apiEdge.tiempo,
                        accion: apiEdge.accion,
                        accion_texto: apiEdge.accion_texto
                    } : null;
                },

                initCytoscape() {
                    console.log('Inicializando Cytoscape...');
                    
                    this.cyRef = cytoscape({
                        container: document.getElementById('cy'),
                        elements: [
                            { 
                                data: { id: 'INICIO', label: 'INICIO' },
                                position: { x: 150, y: 200 }
                            },
                            { 
                                data: { id: 'FIN', label: 'FIN' },
                                position: { x: 1500, y: 200 }
                            },
                        ],
                        style: [
                            {
                                selector: 'node',
                                style: {
                                    label: 'data(label)',
                                    'text-valign': 'top',
                                    'text-halign': 'center',
                                    'background-color': (ele) => 
                                        ele.data('id') === 'INICIO' ? '#007bff' : 
                                        ele.data('id') === 'FIN' ? '#dc3545' : '#28a745',
                                    'width': '80px',
                                    'height': '80px',
                                    'color': '#148a16ff',
                                    'font-size': '16px',
                                    'font-weight': 'bold',
                                    'font-family': 'Segoe UI, Arial, sans-serif',
                                    'text-background-color': 'rgba(0, 0, 0, 0.7)',
                                    'text-background-shape': 'roundrectangle',
                                    'text-background-padding': '4px',
                                    'border-width': '3px',
                                    'border-color': '#ffffff',
                                    'border-style': 'solid',
                                    'shape': 'ellipse',
                                    'events': 'yes',
                                    'overlay-padding': '6px',
                                },
                            },
                            {
                                selector: 'node[id = "INICIO"]',
                                style: {
                                    'background-color': '#007bff',
                                    'border-color': '#0056b3',
                                    'font-size': '16px',
                                    'font-weight': 'bold',
                                    'text-background-color': 'rgba(0, 0, 0, 0.7)',
                                    'text-background-shape': 'roundrectangle',
                                    'text-background-padding': '5px',
                                    'shape': 'roundrectangle',
                                },
                            },
                            {
                                selector: 'node[id = "FIN"]',
                                style: {
                                    'background-color': '#dc3545',
                                    'border-color': '#c82333',
                                    'font-size': '16px',
                                    'font-weight': 'bold',
                                    'text-background-color': 'rgba(0, 0, 0, 0.7)',
                                    'text-background-shape': 'roundrectangle',
                                    'text-background-padding': '5px',
                                    'shape': 'roundrectangle',
                                    'overlay-padding': '8px',
                                    'overlay-color': '#dc3545',
                                    'overlay-opacity': 0.1,
                                },
                            },
                            {
                                selector: 'edge',
                                style: {
                                    'curve-style': 'bezier',
                                    'target-arrow-shape': 'triangle',
                                    'line-color': '#00f',
                                    'target-arrow-color': '#00f',
                                    'width': '3px',
                                },
                            },
                            {
                                selector: 'node.source-selected',
                                style: {
                                    'border-width': '5px',
                                    'border-color': '#ff6b35',
                                    'overlay-padding': '10px',
                                    'overlay-color': '#ff6b35',
                                    'overlay-opacity': 0.2,
                                },
                            },
                            {
                                selector: 'node.potential-target',
                                style: {
                                    'border-width': '4px',
                                    'border-color': '#28a745',
                                    'overlay-padding': '8px',
                                    'overlay-color': '#28a745',
                                    'overlay-opacity': 0.15,
                                },
                            },
                        ],
                        layout: { 
                            name: 'preset',
                            padding: 20
                        },
                        userZoomingEnabled: true,
                        userPanningEnabled: true,
                        boxSelectionEnabled: false,
                        autoungrabify: false,
                        autounselectify: false,
                    });

                    this.setupCytoscapeEvents();
                },

                setupCytoscapeEvents() {
                    let sourceNode = null;
                    let isConnecting = false;

                    this.cyRef.on('tap', 'node', (event) => {
                        const targetNode = event.target;
                        const targetId = targetNode.data('id');
                        const originalEvent = event.originalEvent;
                        const isCtrlPressed = originalEvent && (originalEvent.ctrlKey || originalEvent.metaKey);
                        
                        console.log('Tap en nodo:', targetId, 'isConnecting:', isConnecting, 'Ctrl pressed:', isCtrlPressed);
                        
                        if (sourceNode && isConnecting) {
                            if (sourceNode === targetNode) {
                                console.log('‚ö†Ô∏è Clic en el mismo nodo, cancelando conexi√≥n');
                                this.cyRef.nodes().removeClass('source-selected potential-target');
                                sourceNode = null;
                                isConnecting = false;
                                return;
                            }
                            
                            if (isCtrlPressed) {
                                const sourceId = sourceNode.data('id');
                                console.log('üîó Ctrl + Clic: Intentando conectar:', sourceId, '->', targetId);

                                const connectionExists = this.edges.some(e => e.source === sourceId && e.target === targetId);
                                if (!connectionExists) {
                                    const edgeId = `${sourceId}-${targetId}`;
                                    
                                    const edgeExistsInGraph = this.cyRef.edges(`[id="${edgeId}"]`).length > 0;
                                    
                                    if (!edgeExistsInGraph) {
                                        this.edges.push({ source: sourceId, target: targetId });
                                        console.log('‚úÖ Nueva arista a√±adida:', sourceId, '->', targetId);
                                        
                                        try {
                                            this.cyRef.add({
                                                group: 'edges',
                                                data: { 
                                                    id: edgeId,
                                                    source: sourceId, 
                                                    target: targetId 
                                                }
                                            });
                                            console.log('üîó Arista agregada directamente al grafo con ID:', edgeId);
                                        } catch (error) {
                                            console.error('‚ùå Error al agregar arista:', error);
                                        }
                                    }
                                    
                                    this.cyRef.nodes().removeClass('source-selected potential-target');
                                    sourceNode = null;
                                    isConnecting = false;
                                } else {
                                    console.log('‚ö†Ô∏è La conexi√≥n ya existe');
                                }
                            }
                        } else {
                            if (targetId !== 'FIN') {
                                sourceNode = targetNode;
                                isConnecting = true;
                                console.log('üîó Nodo origen seleccionado:', targetId);
                                
                                this.cyRef.nodes().removeClass('source-selected potential-target');
                                sourceNode.addClass('source-selected');
                                
                                this.cyRef.nodes().forEach(node => {
                                    const nodeId = node.data('id');
                                    const connectionExists = this.edges.some(e => e.source === targetId && e.target === nodeId);
                                    if (nodeId !== targetId && !connectionExists) {
                                        node.addClass('potential-target');
                                    }
                                });
                            }
                        }
                        
                        event.stopPropagation();
                    });

                    this.cyRef.on('tap', (event) => {
                        if (event.target === this.cyRef) {
                            this.cyRef.nodes().removeClass('source-selected potential-target');
                            sourceNode = null;
                            isConnecting = false;
                        }
                    });

                    this.cyRef.on('dblclick', 'edge', (event) => {
                        const edge = event.target;
                        const sourceId = edge.source().id();
                        const targetId = edge.target().id();
                        
                        console.log('üóëÔ∏è Doble clic en arista, De:', sourceId, 'A:', targetId);
                        
                        this.edges = this.edges.filter(e => !(e.source === sourceId && e.target === targetId));
                        
                        try {
                            this.cyRef.remove(edge);
                            console.log('‚úÖ Arista eliminada del grafo');
                        } catch (error) {
                            console.error('‚ùå Error al eliminar arista del grafo:', error);
                        }
                        
                        event.stopPropagation();
                    });
                },

                updateCytoscapeGraph() {
                    if (!this.cyRef) return;

                    console.log('Actualizando grafo Cytoscape...');

                    const allNodes = [
                        { 
                            data: { id: 'INICIO', label: 'INICIO' },
                            position: { x: 150, y: 200 }
                        },
                        { 
                            data: { id: 'FIN', label: 'FIN' },
                            position: { x: 1500, y: 200 }
                        },
                        ...this.selectedItems.map((item, index) => ({ 
                            data: { id: item, label: item },
                            position: { x: 350 + (index * 150), y: 200 }
                        })),
                    ];

                    const currentPositions = {};
                    this.cyRef.nodes().forEach(node => {
                        const pos = node.position();
                        currentPositions[node.data.id] = { x: pos.x, y: pos.y };
                    });

                    const existingNodeIds = this.cyRef.nodes().map(node => node.id());
                    const newNodeIds = allNodes.map(n => n.data.id).filter(id => !existingNodeIds.includes(id));
                    const removedNodeIds = existingNodeIds.filter(id => !allNodes.some(n => n.data.id === id));
                    
                    if (removedNodeIds.length > 0) {
                        console.log('Removiendo nodos:', removedNodeIds);
                        removedNodeIds.forEach(nodeId => {
                            this.cyRef.remove(`node[id="${nodeId}"]`);
                        });
                    }
                    
                    if (newNodeIds.length > 0) {
                        console.log('Agregando nodos nuevos:', newNodeIds);
                        const newNodes = allNodes.filter(node => newNodeIds.includes(node.data.id));
                        this.cyRef.add(newNodes);
                    }
                    
                    const currentEdgeIds = this.cyRef.edges().map(edge => edge.id());
                    const missingEdges = this.edges.filter(edge => {
                        const edgeId = `${edge.source}-${edge.target}`;
                        return !currentEdgeIds.includes(edgeId);
                    });
                    
                    if (missingEdges.length > 0) {
                        console.log('üîó Restaurando aristas perdidas:', missingEdges);
                        missingEdges.forEach(edge => {
                            const edgeId = `${edge.source}-${edge.target}`;
                            try {
                                this.cyRef.add({
                                    group: 'edges',
                                    data: { 
                                        id: edgeId,
                                        source: edge.source, 
                                        target: edge.target 
                                    }
                                });
                            } catch (error) {
                                console.log('‚ö†Ô∏è No se pudo restaurar arista:', edgeId);
                            }
                        });
                    }
                    
                    this.cyRef.nodes().forEach(node => {
                        const nodeId = node.data('id');
                        if (currentPositions[nodeId]) {
                            node.position(currentPositions[nodeId]);
                        }
                        node.ungrabify(false);
                        node.unselectify(false);
                        node.grabify();
                    });
                    
                    if (newNodeIds.length > 0 && this.selectedItems.length > 0) {
                        this.cyRef.fit(this.cyRef.elements(), 80);
                        this.cyRef.zoom(0.6);
                    } else if (this.selectedItems.length === 0) {
                        this.cyRef.fit(this.cyRef.elements(), 80);
                        this.cyRef.zoom(0.6);
                    }

                    if (this.edges.length === 0) {
                        this.cyRef.edges().remove();
                        console.log('üßπ Todas las aristas han sido limpiadas');
                    }
                },

                centerGraph() {
                    if (this.cyRef) {
                        this.cyRef.fit(this.cyRef.elements(), 80);
                        this.cyRef.zoom(0.6);
                    }
                },

                clearConnections() {
                    this.edges = [];
                    if (this.cyRef) {
                        this.cyRef.elements('edge').remove();
                    }
                }
            }
        }
    </script>
</body>
</html>